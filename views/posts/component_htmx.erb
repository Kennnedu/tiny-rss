<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tiny RSS</title>
    <link rel=icon href="data:,">
    <link rel="stylesheet" href="posts/component/index.css">
    <script src="https://unpkg.com/htmx.org@1.9.5" integrity="sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO" crossorigin="anonymous"></script>
  </head>
  <body>
    <header>
      <a href="/" data-turbo="false">&larr; Back</a>
      <span>Rest: <strong id="rest-counter"><%= @posts_rest %></strong></span>
    </header>
    <main>
      <section class="posts" id="posts">
        <% @posts.each do |post| -%>
          <article class="post" id="post-<%= post[:id] %>">
            <section class="post__content <%= post[:viewed_at].nil? ? '' : 'post__content_viewed' %>">
              <div class="post__title">
                <%= post[:title] %>
              </div>
              <div class="post__info">
                <div class="post__meta">
                  <%= "#{URI(post[:link]).host} / #{post[:published_at].strftime('%d %b %Y %H:%M %Z')}" %>
                </div>
                <div class="post__tools tools">
                  <txt-copy text="<%= post[:link] %>"><div class="tool tool__clipboard"></div></txt-copy>
                  <a href="<%= post[:link] %>" class="tool tool__link" target="_blank"></a>
                  <%# <a href="#" class="tool tool__pocket"></a> %>
                  <a href="/posts/<%= post[:id] %>/read_later?stream=true" class="tool tool__bookmark <%= post[:read_later_at].nil? ? '' : ' active' %>" data-turbo-method="patch"></a>
                  <a href="/posts/<%= post[:id] %>/star?stream=true" class="tool tool__star <%= post[:starred_at].nil? ? '' : ' active' %>" data-turbo-method="patch"></a>
                </div>
              </div>
            </section>
          </article>
        <% end -%>
        <div class="page-end">
          <% if @posts.next_page -%>
            <a href="/posts?<%= URI.encode_www_form(@posts_params.to_h.merge(page: @posts.next_page, stream: true)) -%>" hidden="" data-next-page>Next</a>
          <% end -%>
          <% if @posts_params[:unviewed] && !@posts.current_page_record_count.zero? && @posts.last_page? -%>
            <form action="/posts/view" method="post">
              <input type="hidden" name="_method" value="PUT" />
              <% @posts_params.to_h.each_pair do |key, value| %>
                <% if value -%>
                  <input type="hidden" name="<%= key %>" value="<%= value %>" />
                <% end -%>
              <% end -%>
              <input type="hidden" name="post[viewed_at]" value="<%= @posts_params[:published_lt] %>" />
              <button type="submit" class="button">Mark All As Viewed</button>
            </form>
          <% end -%>
          <% if @posts.pagination_record_count.zero? -%>
            <p>There are no articles.</p>
          <% end -%>
        </div>
      </section>
    </main>
    <%= erb(:'/posts/_ui_components', layout: false)  %>
  </body>
</html>
